<!doctype html>
<html lang="en">
  <head>
    <title>Оперативный план</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    {% load static %}
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" >
    <!-- Bootstrap JS + Popper JS -->
    <script defer src="/static/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="{% static 'css/styles_mh.css' %}" />
    <link rel="shortcut icon" href="/static/image/site_logo.png" />

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var form = document.querySelector('form');
        var loadingIndicator = document.getElementById('loadingIndicator');
        var submitButton = document.getElementById('startButton');
        var downloadButton = document.getElementById('downloadButton');

        form.addEventListener('submit', function() {
          loadingIndicator.style.display = 'block';
          submitButton.disabled = true;
          submitButton.value = 'Ожидайте...';
        });

        if (downloadButton) {
          downloadButton.addEventListener('click', function() {
            window.location.href = downloadButton.getAttribute('data-url');
          });
        }

        function downloadFile() {
          var fileUrl = downloadButton.getAttribute('data-url');

          // Создаем временную ссылку
          var link = document.createElement('a');
          link.href = fileUrl;

          // Добавляем ссылку на страницу и вызываем событие click
          document.body.appendChild(link);
          link.click();

          // Удаляем ссылку после скачивания файла
          document.body.removeChild(link);
        }
      });
    </script>

  </head>

  <body style="margin: 0; overflow: scroll">
    <header class="header">
      <a href="/homepage/">
        <img class="header__logo" src="/static/image/polyus_logo.png">
      </a>
    </header>

    <h1 class="page_header">Оперативный план</h1>

    <!-- Индикатор загрузки -->
    <div id="loadingIndicator">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <form method="POST" style="margin-left: 10px; margin-top: 40px;" action="{% url 'op' %}" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
              <label for="branch" class="form-label">Филиал:</label>
              <select name="select_branch" class="form-select" id="branch">
                <option value="IRK">IRK</option>
                <option value="KRS">KRS</option>
                <option value="MGD">MGD</option>
                <option value="YAK">YAK</option>
              </select>
            </div>

            <div class="mb-3">
              <div class="row">
                <div class="col">
                  <label for="month" class="form-label">Месяц:</label>
                  <select name="select_month" class="form-select" id="month">
                    <option value="Январь">Январь</option>
                    <option value="Февраль">Февраль</option>
                    <option value="Март">Март</option>
                    <option value="Апрель">Апрель</option>
                    <option value="Май">Май</option>
                    <option value="Июнь">Июнь</option>
                    <option value="Июль">Июль</option>
                    <option value="Август">Август</option>
                    <option value="Сентябрь">Сентябрь</option>
                    <option value="Октябрь">Октябрь</option>
                    <option value="Ноябрь">Ноябрь</option>
                    <option value="Декабрь">Декабрь</option>
                  </select>
                </div>

                <div class="col">
                  <label for="year" class="form-label">Год:</label>
                  <select name="select_year" class="form-select" id="year">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="formPlanFile" class="form-label">
                Объемный план:
                <a href="" class="custom-tooltip">
                  <img class="question_logo" src="/static/image/question.svg">
                  <span class="tooltip-text">Файл с потребностью от заказчиков</span>
                </a>
              </label>
              <input name="plan_file" class="form-control" type="file" accept=".xl*" id="formPlanFile" required>
            </div>

            <div class="mb-3">
              <label for="formDirectoryFile" class="form-label">
                Справочник:
                <a href="" class="custom-tooltip">
                  <img class="question_logo" src="/static/image/question.svg">
                  <span class="tooltip-text">Файл со списком доступных ресурсов</span>
                </a>
              </label>
              <input name="dir_file" class="form-control" type="file" accept=".xl*" id="formDirectoryFile" required>
            </div>

            <input id="startButton" type="submit" class="btn btn-warning upload" value="Загрузить" style="margin-top: 15px; width: 100%;">

            {% if display_success %}
            <button type="button" id="downloadButton" onclick="downloadFile()" class="btn btn-warning upload" style="margin-top: 15px; width: 100%;" data-url="{% url 'download_op' %}">Скачать</button>
            {% endif %}
          </form>

          {% if display_error %}
          <div class="alert alert-danger" role="alert" id="alert_message" style="margin-top: 20px; width: auto;">
            {{ display_text|safe }}
          </div>

          <script>
            setTimeout(function() {
              document.getElementById('alert_message').style.display = 'none';
            }, 3000);
          </script>
          {% endif %}

          {% if display_success %}
          <div class="alert alert-success" role="alert" id="success_message" style="margin-top: 20px; width: auto;">
            {{ display_text|safe }}
          </div>

          <script>
            setTimeout(function() {
              document.getElementById('success_message').style.display = 'none';
            }, 3000);
          </script>
          {% endif %}
        </div>

        <div class="col-md-6">
          {{ html_table|safe }}
        </div>
      </div>
    </div>
  </body>
</html>
